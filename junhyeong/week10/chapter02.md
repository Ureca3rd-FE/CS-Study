# 10μ£Όμ°¨ π›λ„¤νΈμ›ν¬

## Chap02. TLS/SSL HandShake

### #1. TLSμ™€ SSL

#### SSL (Secure Sockets Layer)

- λ„·μ¤μΌ€μ΄ν”„κ°€ λ§λ“  μ΄μ°½κΈ° μ›Ή λ³΄μ• ν”„λ΅ν† μ½
- λ²„μ „: SSL 2.0, SSL 3.0
- ν„μ¬λ” λ³΄μ• μ·¨μ•½μ (POODLE λ“±) λ•λ¬Έμ— μ‚¬μ‹¤μƒ μ‚¬μ© μ¤‘λ‹¨

#### TLS (Transport Layer Security)

- IETFμ—μ„ SSL 3.0μ„ κΈ°λ°μΌλ΅ ν‘μ¤€ν™”ν• ν”„λ΅ν† μ½
  - TLS 1.0μ€ μ‚¬μ‹¤μƒ SSL 3.1μ— ν•΄λ‹Ή
  - λ¬Έμ μ  λ³΄μ™„ λ° ν‘μ¤€ν™” λ²„μ „μ„
- SSLμ ν›„μ† λ²„μ „μ΄μ κ°μ„ λ ν‘μ¤€
  - λ” κ°•λ ¥ν• μ•κ³ λ¦¬μ¦ μ§€μ› (AES, ECDHE λ“±)
  - ν‚¤ κµν™ κµ¬μ΅° κ°μ„  (Diffie-Hellman κ³„μ—΄)
  - TLS 1.3μ—μ„ ν•Έλ“μ…°μ΄ν¬ λ‹¨μν™” + μ†λ„ ν–¥μƒ + λ³΄μ• κ°•ν™”
- TLS λ²„μ „: HTTPSκ°€ μ‚¬μ©ν•λ” λ³΄μ• ν”„λ΅ν† μ½(TLS)μ λ²„μ „ λ²νΈ
  - TLS 1.0: μ›λ‚ , μ·¨μ•½ -> λ” μ΄μƒ μ‚¬μ©ν•μ§€ μ•μ
  - TLS 1.1: μ·¨μ•½ -> λ” μ΄μƒ μ‚¬μ©ν•μ§€ μ•μ
  - TLS 1.2: ν„μ¬λ„ λ„λ¦¬ μ‚¬μ©
  - TLS 1.3: μµμ‹ , κ°€μ¥ μ•μ „

#### SSLμ΄ νκΈ°λκ³  TLSκ°€ ν‘μ¤€μ΄ λ μ΄μ 

1. SSL 2.0, 3.0μ€ μ—¬λ¬ μΉλ…μ μΈ μ·¨μ•½μ  μ΅΄μ¬
   - λ‹¤μ΄κ·Έλ μ΄λ“ κ³µκ²©, POODLE κ³µκ²© λ“±
   - ν„λ€ λΈλΌμ°μ €Β·μ„λ²„μ—μ„ SSLμ€ κΈ°λ³Έμ μΌλ΅ λΉ„ν™μ„±ν™”
2. TLSλ” SSLμ κµ¬μ΅°λ¥Ό κ³„μΉν•λ©΄μ„ λ³΄μ•μ„±μ„ κ°•ν™”
   - λ” μ•μ „ν• μ•”νΈ μ•κ³ λ¦¬μ¦ λ„μ…
   - ν”„λ΅ν† μ½ μ„¤κ³„ κ°μ„  (ν•Έλ“μ…°μ΄ν¬, ν‚¤ κµν™ λ°©μ‹ λ“±)
   - λ²„μ „μ΄ μ¬λΌκ°μλ΅ μ·¨μ•½μ  μ κ±° λ° μ„±λ¥ κ°μ„ 

---

### #2. μ§„ν–‰ μμ„ (TLS 1.2μ νλ¦„ κΈ°μ¤€ - μ „ν†µμ )

#### 1λ‹¨κ³„: ClientHello

- ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„

  - μ‚¬μ© κ°€λ¥ν• TLS λ²„μ „ λ©λ΅ μ μ‹
  - μ§€μ›ν•λ” Cipher Suite λ©λ΅ μ μ‹
  - μ„Έμ… μ¬μ‚¬μ© μ •λ³΄(Session ID, Session Ticket λ“±) ν¬ν•¨ κ°€λ¥

- **TLS 1.3 μ°¨μ΄**
  - λ” μ΄μƒ TLS 1.0/1.1 μ§€μ› X
  - 1-RTT/0-RTT ν•Έλ“μ…°μ΄ν¬ κµ¬μ΅°λ¥Ό μ„ν•΄ μΌλ¶€ ν™•μ¥ ν•„λ“ μ¶”κ°€

#### 2λ‹¨κ³„: ServerHello

- μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ

  - μ‚¬μ©ν•  TLS λ²„μ „ μ„ νƒ (μ: TLS 1.2 λλ” 1.3)
  - μ‚¬μ©ν•  Cipher Suite μ„ νƒ
  - μ„Έμ… μ¬μ‚¬μ© μ—¬λ¶€ κ²°μ •

- **TLS 1.3 μ°¨μ΄**
  - μ΄ λ‹¨κ³„μ—μ„ κ³§λ°”λ΅ ν‚¤ κµν™μ© νλΌλ―Έν„°(ECDHE κ°’) λ„ ν•¨κ» λ³΄λƒ„
  - μ΄ν›„ λ©”μ‹μ§€ μƒλ‹Ή λ¶€λ¶„μ΄ μ•”νΈν™”λ μƒνƒλ΅ μ§„ν–‰

#### 3λ‹¨κ³„: μ„λ²„ μΈμ¦μ„(Certificate) μ „μ†΅

- μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ

  - μ„λ²„ μΈμ¦μ„ μ „μ†΅
  - μ„λ²„ μΈμ¦μ„: κ³µκ°ν‚¤ + CA(μΈμ¦ κΈ°κ΄€)μ μ„λ… ν¬ν•¨

- **TLS 1.3 μ°¨μ΄**
  - Certificate, CertificateVerify, EncryptedExtensions λ“±μΌλ΅ μ„Έλ¶„ν™” (μΌλ¶€λ” μ•”νΈν™”)

#### 4λ‹¨κ³„: ServerKeyExchange / ServerHelloDone

- ServerKeyExchange: ν‚¤ κµν™μ— ν•„μ”ν• μ¶”κ°€ μ •λ³΄ μ „μ†΅(DH/ECDHE νλΌλ―Έν„° λ“±)
- ServerHelloDone: "μ„λ²„ μΈ΅ μ΄κΈ° μΈμ‚¬ λ" μ΄λΌλ” ν‘μ‹

- **TLS 1.3 μ°¨μ΄**
  - λ³„λ„μ HelloDone μ—†μ
  - ν‚¤ κµν™ κ΄€λ ¨ μ •λ³΄λ” λ€λ¶€λ¶„ ServerHello μ‹μ  λλ” μ΄ν›„ μ•”νΈν™”λ ν™•μ¥ λ©”μ‹μ§€μ—μ„ μ²λ¦¬

#### 5λ‹¨κ³„: ν΄λΌμ΄μ–ΈνΈμ μΈμ¦μ„ κ²€μ¦

- λΈλΌμ°μ €/OSμ— λ‚΄μ¥λ μ‹ λΆ°ν•  μ μλ” CA λ©λ΅κ³Ό λΉ„κµ
- λ„λ©”μΈ μΌμΉ μ—¬λ¶€ ν™•μΈ
- λ§λ£ μ—¬λ¶€, νκΈ° μ—¬λ¶€(OCSP/CRL) ν™•μΈ
- κ²€μ¦ μ‹¤ν¨ μ‹: "μ΄ μ‚¬μ΄νΈλ” μ•μ „ν•μ§€ μ•μ" κ²½κ³ 

- **TLS 1.3 μ°¨μ΄**
  - κ²€μ¦ μμ²΄λ” λ™μΌ κ°λ…

#### 6λ‹¨κ³„: ν‚¤ κµν™ λ° μ„Έμ…ν‚¤ μƒμ„±

- ν΄λΌμ΄μ–ΈνΈ
  - **Pre-Master Secret** μƒμ„±
  - μ„λ²„ κ³µκ°ν‚¤λ΅ Pre-Master Secret μ•”νΈν™” ν›„ μ „μ†΅ (ClientKeyExchange)
- μ„λ²„
  - κ°μΈν‚¤λ΅ λ³µνΈν™”ν•μ—¬ **Pre-Master Secret** νλ“
- μ–‘μ½

  - **Master Secret** (μ„Έμ…ν‚¤-λ€μΉ­ν‚¤) μƒμ„±: Client Random + Server Random + Pre-Master Secretλ¥Ό μ΅°ν•©

- **TLS 1.3 μ°¨μ΄**
  - λ” μ΄μƒ "κ³µκ°ν‚¤λ΅ μ„Έμ…ν‚¤λ¥Ό μ•”νΈν™”ν•΄μ„ λ³΄λ‚΄μ§€ μ•μ"
  - λ€μ‹  ECDHE κΈ°λ° Diffie-Hellman ν‚¤ κµν™ μ‚¬μ©
    - ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„κ°€ μ„λ΅μ κ³µκ° ν‚¤ κµν™ κ°’μ„ μ£Όκ³ λ°›κ³ ,
    - κ°κ° λ™μΌν• μ„Έμ…ν‚¤λ¥Ό κ³„μ‚° (DH μ—°μ‚° κ²°κ³Ό)
    - μ†λ„ λ° λ³΄μ• ν–¥μƒ

#### 7λ‹¨κ³„: μ•”νΈν™” μ¤μ„μΉ(ChangeCipherSpec) & Finished

- ν΄λΌμ΄μ–ΈνΈ

  - ChangeCipherSpec: μ•”νΈν™”ν•΄μ„ λ³΄λ‚΄κ² λ‹¤λ” μ„ μ–Έ
  - Finished λ©”μ‹μ§€: μ§€κΈκΉμ§€μ ν•Έλ“μ…°μ΄ν¬κ°€ μ •μƒμ μΌλ΅ λλ‚¬λ‹¤λ” MAC μ „μ†΅

- μ„λ²„

  - ChangeCipherSpec + Finished μ‘λ‹µ

- **TLS 1.3 μ°¨μ΄**
  - ChangeCipherSpecκ°€ μ‚¬μ‹¤μƒ κ±°μ ν•„μ” μ—†μ–΄μ§ (ν•Έλ“μ…°μ΄ν¬ κµ¬μ΅°κ°€ λ‹¨μν™”)
  - Finished λ©”μ‹μ§€: μ–‘μ½ λ¨λ‘ ν•Έλ“μ…°μ΄ν¬λ” λλ‚¬κ³ , μ„Έμ…ν‚¤λ„ κ°™μμ„ κ²€μ¦

#### 8λ‹¨κ³„: μ• ν”λ¦¬μΌ€μ΄μ… λ°μ΄ν„° μ „μ†΅ μ‹μ‘ (μ•”νΈν™”λ HTTP)

- HTTP Request/Response λ°μ΄ν„°κ°€ μ „λ¶€ μ„Έμ…ν‚¤(AES λ“±)λ΅ μ•”νΈν™”λμ–΄ μ „μ†΅
- λ„μ²­/λ³€μ΅°κ°€ μ‚¬μ‹¤μƒ λ¶κ°€λ¥ν•΄μ§

#### 9λ‹¨κ³„: μ„Έμ… μ¬μ‚¬μ© / μ¬κ° (Session Resumption)

- TLS 1.2: Session ID, Session Ticket λ°©μ‹μΌλ΅ μ„Έμ… μ¬κ°
- TLS 1.3: 0-RTT, PSK(Pre-Shared Key) λ°©μ‹ μ μ©
  - κ°™μ€ μ„λ²„μ— λ‹¤μ‹ μ ‘μ†ν•  λ• ν•Έλ“μ…°μ΄ν¬ κ³Όμ •μ„ μ¤„μ—¬ μ†λ„ ν–¥μƒ

#### TLS 1.2μ™€ TLS 1.3 λ‹¨κ³„ μ°¨μ΄

- TLS 1.2 ν•Έλ“μ…°μ΄ν¬: 1-9 λ‹¨κ³„
- TLS 1.3 ν•Έλ“μ…°μ΄ν¬: 1-4 λ‹¨κ³„ (TLS 1.2μ 1, 2, 7, 8 λ‹¨κ³„)

---

### #3. TLSκ°€ μ κ³µν•λ” 3λ€ λ³΄μ• μ”μ†

#### 1. μ•”νΈν™” (Encryption)

    - λ°μ΄ν„°κ°€ μ¤‘κ°„μ—μ„ λ³΄μ΄κ±°λ‚ λ„μ²­λμ§€ μ•λ„λ΅ λ³΄νΈ
    - μ‹¤μ  λ°μ΄ν„°λ” λ€μΉ­ν‚¤λ΅ μ•”νΈν™”

#### 2. λ¬΄κ²°μ„± (Integrity)

    - λ°μ΄ν„°κ°€ μ¤‘κ°„μ— λ³€μ΅°λμ§€ μ•λ„λ΅ λ³΄μ¥
    - HMAC or AEAD(GCM)λ¥Ό μ΄μ©ν•μ—¬ μ²΄ν¬
        - MAC (Message Authentication Code) : λ°μ΄ν„°κ°€ λ³€μ΅°λμ§€ μ•κ² λ¶™μ΄λ” κ°’
        - ν•΄μ‹(Hash) : SHA-256, SHA-512 κ°™μ€ λ‹¨λ°©ν–¥ ν•¨μ (ν•΄μ‹λ§μΌλ΅λ” λ¬΄κ²°μ„± λ³΄μ¥ λ¶κ°€)
        - HMAC: Hash κΈ°λ° MAC (ν•΄μ‹μ™€ λΉ„λ°€ν‚¤λ¥Ό μ΅°ν•©ν•μ—¬ λ§λ“  MAC)
        - AEAD: μ•”νΈν™” + μΈμ¦ νƒκ·Έ κΈ°λ° λ¬΄κ²°μ„±μ„ λ™μ‹μ— μ κ³µν•λ” λ°©μ‹

#### 3. μΈμ¦ (Authentication)

     - μ ‘μ†ν• μ„λ²„κ°€ μ§„μ§ μ„λ²„μΈμ§€ ν™•μΈ
     - CA μΈμ¦μ„(κ³µμΈ μΈμ¦μ„)λ¥Ό κΈ°λ°μΌλ΅ μ„λ²„ μ‹ μ› ν™•μΈ
