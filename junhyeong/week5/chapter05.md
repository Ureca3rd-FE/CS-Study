# 🖲️운영체제 5주차

## Chap10. 경쟁 상태 (Race Condition)

### #0. 임계 구역(Critical Section)

#### 개념

- 여러 프로세스/스레드가 공유자원에 접근하는 코드 부분 중, 한번에 하나만 실행되어야하는 구역
- 공유 자원에 접근하는 코드 구역 : 동시에 접근하면 문제가 생길 수 있는 구역
- 경쟁상태를 방지하기 위한 개념

#### 특징

- 공유 변수, 파일, 메모리 등을 동시에 수정 시 충돌이 일어남 -> 동시에 작업하면 안됨
- 어떤 프로세스가 임계구역에 들어갈 경우, 다른 프로세스는 임계구역 밖에서 기다려야 함

#### 임계 구역의 조건

1. 상호 배제 (Mutual Exclusion) : 한 번에 하나의 프로세스만 임계 구역 실행 가능
2. 한정 대기 (Bounded Waitting)

   - 어떤 프로세스도 무한정 기다리지 않아야 함
   - 어떤 프로세스가 임계 구역 진입을 요청한 이후, 다른 프로세스들이 임계 구역에 들어가는 횟수에 한계가 생겨야함.

3. 진행 (Progress) : 한 프로세스가 임계 구역에 있지 않을 때, 진입 대기 중인 다른 프로세스가 있다면 진입할 수 있어야 한다.

---

### #1. 경쟁 상태란?

#### 개념

- 여러 프로세스/스레드가 동시에 같은 자원에 접근할 때, 실행 순서에 따라 결과가 달라지는 현상
- 실행 순서에 의해 프로그램 결과가 달라지는 비결정적 상태
- 임계 구역이 보호되지 않을 때 발생하는 문제

#### 특징

- 원인
  - 여러 프로세스가 공유 자원에 동시에 접근함 (이미 일어난 상황)
  - 실행 순서에 따라 결과가 달라짐
- 결과 : 데이터 불일치, 시스템 오작동, 예측 불가능한 결과
- 발생 위치 : 임계 구역 (공유 자원에 접근하는 코드)

### #2. 경쟁상태가 발생하는 상황

#### 1. 공유자원에 동시에 접근하는 상황

- 가장 일반적인 상황으로 볼 수 있음
- 두 스레드가 동일한 변수에 공유 && 과정이 원자적으로 수행되지 않음
- 예시 : 은행 잔액 처리

```
balance = 1000

Thread A: if balance >= 700: balance -= 700
Thread B: if balance >= 700: balance -= 700
```

- 스레드 A, B가 동시에 접근 시 잔액이 -400이 되는 논리적 오류가 발생

---

#### 2. 임계 구역에 대한 동시 접근하는 상황

- 공유 자원이 코드 구역인 경우
- 여러 프로세스가 임계구역 진입 조건을 동시에 통과 -> 그 안에서의 작업이 겹침
- 예시 : 생산자 - 소비자 문제
  - 생산자는 버퍼(데이터를 주고 받는 공간)내의 공간을 채우고, 버퍼를 줄이는 역할
  - 생산자가 데이터를 채우는 도중, 사용자가 데이터를 꺼내면 완전히 저장되지 않은 데이터를 읽게됨

#### 3. 하드웨어 자원을 공유하는 상황

- 프로세스가 같은 장치에 동시에 접근하는 경우
- 예시 : 두 프로세스가 프린터 장치를 동시에 사용
  - 프로세스 A는 공주 그림 출력을 요청
  - 프로세스 B는 물고기 그림 출력을 요청
  - 결과 : 인어공주 그림이 출력

---

### #3. 경쟁 상태의 해결 방법

#### 소프트웨어적 해결 방법 : 하드웨어의 도움 없이, 프로그램 논리만으로 임계 구역을 제어하는 방식

- 예시

  - 데커 알고리즘
  - 피터슨 알고리즘
  - 뮤텍스

- 한계
  - lock을 걸어놓은 상태에서 타임슬라이스가 발생했을때 lock을 해제하지 못하여 무한대기가 발생하게됨

#### 하드웨어적 해결 방법

- Test-and-Set 명령어 : 공유 변수(lock)를 검사하고 동시에 설정하는 명령어 (임계 구역 보호)
- 특징 : 소프트웨어적 한계를 보완
- 한계
  - 바쁜대기의 존재
  - 한정 대기 조건 미보장
  - 확장성 부족 : 멀티 코어 시스템에서 불가하여 현실적으로 불가능

#### 운영체제 수준의 해결 수단

1. 세마포어

- 개념

  - 프로세스가 임계구역 진입하기 전에 스위치를 사용중으로 놓음
  - 공유 자원 접근 가능한 스레드의 개수를 제한하는 동기화 도구 (정수형 변수)

- 내부 코드

  - 정수형 변수(RS)를 통해 현재 사용 가능한 자원의 수를 저장
  - P() - wait() : 잠금을 수행하는 코드. RS가 0보다 크면 1감소, 0보다 작으면 0보다 커질 때까지 기다림.
  - V() - signal() : 잠금 해제와 동기화를 수행하는 코드. RS를 1증가 시키고 세마포어에서 기다리는 프로세스에게 진입해도 된다고 하는 signal을 보냄.

- 특징

  - 프로세스가 세마포어를 사용하지 않고 임계구역으로 들어가는 경우 보호 불가
  - 바쁜 대기가 발생할 수 있음 (**바쁜대기** : 특정자원을 얻기 위해서 계속해서 확인하는것)

- 종류
  - 이진 세마포어 : RS 값이 0, 1만 가질 수 있음 -> 뮤텍스와 동일한 기능
  - 계수 세마포어 : RS 값이 여러개의 자원을 의미 -> 동시에 여러 스레드 접근 가능

2. 모니터

- 개념
  - 공유자원을 내부적으로 숨기고 인터페이스(메서드)만 제공하는 방식 (사용자는 wait()/signal()을 통해 조건 동기화만 하면됨)
  - 사용자는 작업요청을 하고, 모니터는 요청받은 작업을 모니터큐에 저장한 뒤 순서대로 처리, 결과만 해당 프로세스에 알려줌

3. 메세지 패싱

- 개념 : 메시지 패싱은 각 프로세스가 독립적으로 동작하면서, 필요한 정보를 메시지 형태로 주고받아 협력하는 방식
- 특징 : 공유 메모리 불필요: 프로세스 간에 메모리를 공유하지 않고도 통신과 동기화가 가능함
