# 🖲️운영체제 5주차

## Chap09.교착 상태 (DeadLock)

### #0. 교착 상태와 경쟁 상태의 차이점

#### 발생 원인

- 교착 상태
  - 자원 점유 후 서로의 자원을 기다릴 때 -> 자원 대기 문제
  - 프로세스간 자원 할당 중 발생
- 경쟁 상태
  - 여러 프로세스가 동시에 같은 자원에 접근할 때 -> 타이밍 문제
  - 프로세스 병행 실행 중 발생

#### 결과

- 교착 상태 : 프로세스가 멈춤
- 경쟁 상태 : 실행 결과가 불확정적

---

### #1. 교착 상태 (DeadLock) 란?

#### 개념

- 두개 이상의 프로세스/스레드가 서로 자원을 얻지 못하여 무한정 대기하는 현상
- 예시
  - 프로세스 A, B 모두 자원 1,2가 필요함
  - 프로세스 A는 자원1을, 프로세스 B는 자원2를 가짐
  - 프로세스 A, B 모두 자원 1,2를 기다림 (무한히 대기)

---

### #2. 교착 상태의 발생 조건 - 식사하는 철학자 문제

#### 1. 상호 배제 (Mutual Exclusion)

- 한 자원을 여러 프로세스가 동시에 사용 불가능
- 철학자는 서로 포크 공유 불가능

#### 2. 점유와 대기 (Hold and Wait)

- 이미 자원을 가진 채로 다른 자원 기다림
- 각 철학자는 다른 철학자의 포크를 빼앗을 수 없음

#### 3. 비선점 (Non-preemption)

- 자원을 강제로 빼앗을 수 없음
- 각 철학자는 왼쪽 포크를 잡은 채 오른쪽 포크 기다림

#### 4. 순환 대기 (Circular Wait)

- 여러 프로세스가 서로의 자원을 기다리며 순환 구조 형성
- 철학자들은 원형으로 앉아 있음

---

### #3. 교착 상태 해결 방법

#### 1. 교착 상태 예방 (prevention)

- 개념
  - 교착 상태를 유발하는 네가지 조건이 발생하지 않도록 무력화 하는 방식
  - 하나라도 조건을 만족하지 않으면 교착상태는 발생하지 않음

1. 상호 배제 예방
   - 개념
     - 독점적으로 사용할 수 있는 자원을 없애는 방법
     - 자원 공유 허용
   - 한계
     - 현실적으로 모든 자원을 공유할 수 없음
     - 상호 배제를 적용하여 보호해야하는 자원이 있음
     - 상호 배제를 무력화하는 것은 사실상 어려움
2. 비선점 예방

   - 개념
     - 모든 자원을 빼앗을 수 있게 하는 방법
     - 선점 허용
   - 한계 : 아사 현상 발생

3. 점유와 대기 예방
   - 개념
     - 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
     - 전부 할당함 OR 아예 할당하지 않음
   - 한계
     - 자원이 필요 없을 때도 할당되어 낭비 발생
     - 무한 대기 발생 가능
     - 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어려움
     - 많은 자원을 사용하는 프로세스는 상대적으로 불리함
     - 일괄 작업 방식으로 동작하게 됨
4. 원형 대기 예방
   - 개념
     - 점유/대기하는 프로세스들이 원형을 이루지 못하게 막는 방법
     - 모든 자원에 숫자를 부여하고, 숫자가 큰 방향으로만 자원을 할당
   - 한계
     - 작업 진행 유연성이 떨어짐
     - 자원에 번호를 어떻게 부여할 것인지가 문제

- 결론
  - 상호 배제 예방, 비선점 예방 : 자원 보호를 위해 사용이 어려움
  - 점유와 대기 예방, 원형 대기 예방 : 프로세스 작업 방식을 제한, 자원 낭비로 사용이 어려움

#### 2. 교착 상태 회피 (aviodance)

- 개념

  - 교착상태가 발생하지 않도록 자원 할당량을 조절하여 회피하는 방식
  - 시스템의 상태를 계속 감시 -> 안정한 상태 유지

- 안정 상태와 불안정 상태

  - 안정 상태
    - 모든 프로세스가 정상적으로 종료가 가능한 상태
    - 안정 상태는 불안정 상태의 일부
  - 불안정 상태
    - 교착 상태가 될 가능성이 있음
    - 할당된 자원이 늘어날수록 불안정 상태 커짐

- 한계

  - 시스템을 항상 감시해야 하므로 오버헤드 발생
  - 프로세스가 사용할 자원을 미리 선언해야 함
  - 시스템 전체 자원 수/프로세스 수가 고정적이어야 함
  - 여유 자원이 있어야함 -> 자원 활용률 낮음

- 은행원 알고리즘

  - 개념 : 교착 상태 회피를 구현하는 알고리즘 (다익스트라 제안)
  - 특징

    - 은행이 대출을 해주는 방식과 유사
      - 대출 금액이 대출 가능한 범위 내이면 (안정 상태이면) 허용
      - 그렇지 않으면 거부
    - 특정 프로세스의 기대 자원이 가용 자원보다 작으면 할당

  - 변수

    - 전체 자원(Total) : 시스템 내 전체 자원의 수
    - 가용 자원(Available) : 시스템 내 현재 사용할 수 있는 자원의 수 (전체자원 - 모든 프로세스의 할당자원)
    - 최대 자원(Max) : 각 프로세스가 선언한 최대 자원의 수
    - 할당 자원(Allocation) : 각 프로세스에 현재 할당된 자원의 수
    - 기대 자원(Expect) : 각 프로세스가 앞으로 사용할 자원의 수 (최대자원 - 할당자원)

  - 알고리즘의 흐름
    1. 각 프로세스의 기대자원 (Max - Allocation)
    2. 현재 가용 자원 (시스템에 남아있는 자원의 양)
    3. 안정 상태 유지를 위한 조건을 반복 검사
       - 현재 가용자원 >= 어떤 프로세스의 기대자원 이면
       - 그 프로세스는 자원을 모두 얻고 종료 가능
    4. 해당 프로세스가 종료하면 쓰던 자원을 모두 반납 -> 남은 프로세스들에 다시 검사
    5. 모든 프로세스가 종료될 때까지 반복
       - 한번이라도 조건을 만족하는 프로세스가 없으면 교착 상태 위험

#### 3. 교착 상태 검출(detection)과 회복(recovery)

- 교착 상태 검출

  - 개념

    - 운영체제가 프로세스 작업을 모니터링하면서 교착상태 발생 여부를 계속 주시하는 방식
    - 자원 할당 그래프에서 사이클이 있으면 교착 상태
    - 교착 상태 발견 시 회복 단계 진입

  - 타임아웃을 이용한 교착 상태 검출

    - 의미
      - 일정 시간동안 작업이 진행되지 않은 프로세스를 교착 상태 발생으로 간주
      - 타임아웃 시 프로세스 종료
    - 데이터베이스에서의 위험성
      - 타임아웃으로 프로세스 종료시 데이터 일관성 깨질 수 있음
      - 체크포인트/롤백으로 문제 발생 시 돌아가는 방식으로 해결

- 교착 상태 회복

  - 개념

    - 교착 상태 발생 시 교착 상태를 풀기 위한 후속 작업
    - 교착 상태를 유발한 프로세스를 강제 종료

  - 방식
    1. 교착 상태를 일으킨 모든 프로세스를 동시에 종료
    2. 우선순위가 낮은 프로세스 먼저 순서대로 종료 ('우선순위' -> '작업시간 짧음' -> '자원 많이 사용'의 순으로 기준을 적용)

#### 4. 교착 상태 무시(ignore)

- 개념
  - 교착 상태가 드물게 발생하는 경우에 사용
  - 재부팅 OR 강제종료 : 예방, 검출은 지속적인 오버헤드 및 성능 저하를 발생시키므로 재부팅/강제종료가 더 효과적
- 한계
  - 데이터 손실의 위험
  - 핵 시스템, 원자력 시스템, 비행기 등 실시간 시스템에서는 적합하지 않음
- 타조 알고리즘 : 타조가 위험이 발생하면 머리를 땅에 박고 무시함
