# 🖲️운영체제 6주차

## Chap11. 세마포어와 뮤텍스

### #0. 경쟁 상태의 해결 방법의 분류

#### 경쟁 상태란?

- 임계 구역 : 공유 자원에 접근하는 코드 구역
- 경쟁 상태 : 임계 구역에 2개 이상의 프로세스가 접근하여 실행순서에 따라 결과가 달라지는 현상

- 임계 구역의 조건
  1. 상호 배제 (Mutual Exclusion) : 한 번에 하나의 프로세스만 임계 구역 실행 가능
  2. 한정 대기 (Bounded Waitting) : 어떤 프로세스도 무한정 기다리지 않아야 함
  3. 진행 (Progress) : 한 프로세스가 임계 구역에 있지 않을 때, 진입 대기 중인 다른 프로세스가 있다면 진입할 수 있어야 한다.

#### 경쟁 상태 해결 방법의 분류

- 소프트웨어적 해결 방법

  1. 피터슨 알고리즘

     - 개념 : 두개의 프로세스/스레드가 임계 구역에 안전하게 들어가도록 하는 상호 배제 알고리즘
     - 특징

       - 프로세스가 2개일 때만 가능
       - 변수만으로 동작 (하드웨어 명령 X)
       - 상호 배제, 한정대기, 진행 3가지 조건 모두 충족

     - 코드 예시

       - turn의 값은 프로세스 번호가 아닌, 다른 프로세스의 lock여부에 따라 기다림 while문의 작동 조건 발동시키기 위한 값

       ```
       // 공유 변수
       boolean lock1 = false;
       boolean lock2 = false;
       int turn = 1;

       // 프로세스1
       lock1 = true;
       turn=2;
       while(lock2==true && turn==2);
       /*
       임계 구역
       */
       lock1 = false;

       // 프로세스2
       lock2 = true;
       turn=1;
       while(lock1==true && turn==1);
       /*
       임계 구역
       */
       lock2 = false;
       ```

  2. 데커 알고리즘

  - 개념 : 최초의 상호 배제 알고리즘
  - 특징
    - 프로세스가 2개일 때만 가능
    - 변수만으로 동작 (하드웨어 명령 X)
  - 코드 예시

    ```
    // 공유변수
    boolean lock1 = false;
    boolean lock2 = false;
    int turn = 1;

    // 프로세스1
    lock1 = true;
    while(lock2==true) {
        if(turn==2) {
            lock1 = false;
            while (turn==2);
            lock1 = true;
        }
    }
    /*
    임계 구역
    */
    turn = 2;
    lock1 = false;

    // 프로세스2
    lock2 = true;
    while(lock1==true) {
        if(turn==1) {
            lock2 = false;
            while (turn==1);
            lock2 = true;
        }
    }
    /*
    임계 구역
    */
    turn = 1;
    lock2 = false;
    ```

  3. 베이커리 알고리즘

  - 개념
    - N개의 프로세스까지 확장 가능한 상호 배제 알고리즘
    - 빵집의 번호표 시스템을 본뜸. 각 프로세스가 번호표를 받고 번호가 작은 프로세스가 임계 구역에 먼저 진입하는 방식
    - 동등한 번호일 때는, 프로세스 번호로 우선순위 결정
  - 특징
    - N개의 프로세스까지 확장 가능한 상호 배제 알고리즘
    - 변수만으로 동작 (하드웨어 명령 X)
    - 선입선출형 락 구현 가능
    - 실제 운영체제에는 거의 쓰이지 않음 -> 메모리 일관성 보장 X, CPU 명령 원자성 보장 X, ...
  - 코드 예시

    ```
    int choosing[n] = {0}; // 번호표 선택중인지 표시
    int number[n] = {0}; // 각 프로세스의 번호표

    // 프로세스i
    choosing[i] = 1;
    number[i] = 1 + max(number[0], ..., number[n-1]);
    choosing[i] = 0;

    for (int j=0; j<n; j++) {
        while (choosing[j]) {/*대기*/}
        while (number[j] != 0 && (number[j] < number[i] ||
       (number[j] == number[i] && j < i))) {
            /* 대기: 자신보다 먼저인 번호 있으면 대기 */
        }
    }
    /*
    임계 구역
    */
    number[i]= 0; // 번호표 반환

    ```

- 하드웨어적 해결 방법

  1. Test-and-Set 명령어
     - 개념
       - CPU가 제공하는 원자적(일련의 절차를 동시에 수행) 명령어
       - lock 변수의 "읽기"와 "쓰기" 사이에 다른 프로세스가 개입할 수 있는 문제(원자성 위반)를 하드웨어적으로 해결하는 명령어
     - 특징
       - 하나의 명령어로 값을 읽고(test) 즉시 수정(set)하는 작업을 수행
       - lock 변수를 읽는 도중(lock 변수 변경 전) 다른 프로세스가 접근하는 문제를 해결
       - 대기하는 프로세스들의 바쁜 대기로 CPU 낭비
       - 진입순서를 고려하지 않아 공정성 문제
     -
  2. Swap 명령어
     - 개념
       - 두 변수의 값을 원자적으로 교환하는 명령어
       - 전역 변수인 lock과 지역 변수인 key(각 프로세스가 가짐)가 존재
     - 특징
       - 반복의사를 가진 프로세스의 key 변수를 true로 할당하고, lock 변수의 값과 Swap하는 것을 시도
       - 대기하는 프로세스들의 바쁜 대기로 CPU 낭비
       - 진입순서가 고려하지 않아 공정성 문제

- 운영체제적 해결 방법
  1. 세마포어 : 동시에 접근할 수 있는 리소스의 개수를 숫자로 제한하여 자원 접근을 제어하는 동기화 도구
  2. 뮤텍스 : 임계 구역에 한번에 하나의 프로세스만 진입하도록 하는 상호 배제를 실현하는 장치
  3. 모니터 : 상호배제와 조건 변수(대기/알림)를 추상화 시킴.

---

### #1. 세마포어

- 개념

  - 프로세스가 임계구역 진입하기 전에 스위치를 사용중으로 놓음
  - 공유 자원 접근 가능한 스레드의 개수를 제한하는 동기화 도구 (정수형 변수)

- 동작 과정

  - 정수형 변수(RS)를 통해 현재 사용 가능한 자원의 수를 저장
  - P() - wait() : 잠금을 수행하는 코드. RS가 0보다 크면 1감소, 0보다 작으면 0보다 커질 때까지 기다림.
  - V() - signal() : 잠금 해제와 동기화를 수행하는 코드. RS를 1증가 시키고 세마포어에서 기다리는 프로세스에게 진입해도 된다고 하는 signal을 보냄.

- 코드 예시

  ```
  // N: 초기 자원 개수
  semaphore S = N

  // P 연산 (자원 점유 시도)
  function wait(S):
      while S <= 0:
          wait // 자원 없으면 대기
      S -= 1

  // V 연산 (자원 해제)
  function signal(S):
      S += 1

  // 사용 예시
  wait(S)
  /*
  임계 구역 작업
  */
  signal(S)
  ```

- 특징
  - 바쁜 대기를 극복 : 대기하는 프로세스는 작업을 마친 프로세스에게서 신호(wake_up)를 받기 전까지 대기 큐에서 대기 상태(block) 유지
  - 바쁜 대기가 발생하는 경우 : 옛날 세마포어인 경우 발생. 현대 세마포어는 블로킹 방식.
  - 임계 구역에 여러 프로세스가 들어가도 되는 이유
    - 임계 구역 자체가 여러 개인 경우
    - 동시에 접근해도 데이터 충돌이 나지 않는 임계 구역인 경우

---

### #2. 뮤텍스

- 개념

  - 상호배제의 영어인 Mutual Exclusion의 약자
  - 즉, 운영체제가 제공하는 락 방식의 동기화 도구
  - 임계구역에 오직 하나의 프로세스만 사용할 수 있도록 잠금을 거는 방식

- 특징
  - 운영체제의 커널이 제공하는 락 객체로 동작. 임계 구역 마다 하나의 락 객체가 있음
  - 락을 획득한 프로세스만 임계구역을 진입. 락을 해제하면 다른 프로세스가 진입 가능
  - 락 소유권이 명확하게 구분됨 : 락을 건 주체만이 락을 해제할 수 있음
  - 소프트웨어적 해결 방법과의 차이점
    - 소프트웨어적 해결방법은 뮤텍스의 원리를 소프트웨어적으로 구현한 것
    - 소프트웨어적 해결 방법은 변수를 이용하여 설계. 뮤텍스는 운영체제가 제공한 객체를 이용하여 동작.
  - 바쁜 대기의 발생 여부 (구현 방식에 따라 다름)
    - 스핀락 방식으로 구현 : 락 이 풀릴 때까지 while문에서 락 상태를 검사하며 CPU를 점유
    - 블로킹 방식으로 구현 : 락을 얻지 못하면, 대기큐에서 대기. CPU를 빠져나가므로 보다 효율적.

---

### #3. 퀴즈

#### 1. 세마포어는 바쁜 대기가 발생하지 않는다. 작업을 마친 프로세스가 wake_up 신호를 보냈을 때, 대기 중인 프로세스가 임계구역에 들어가는 방식이라 그렇다. 이때 대기 중인 프로세스의 상태는 뭐라고 부를까요?

#### 2. 뮤텍스에서 임계구역이 여러개인 경우에는, 어떤 방식으로 작동할까요?

1. 모든 임계구역을 하나의 뮤텍스 락으로 관리해서, 동시에 한 명만 전체 자원을 쓸 수 있도록 한다.

2. 각 임계구역(자원)마다 별도의 뮤텍스 락을 생성해서, 자원별로 한 명만 접근하도록 독립적으로 관리한다.

3. 뮤텍스는 임계구역이 여러 개인 경우를 아예 관리할 수 없다.

4. 여러 임계구역에 동시에 여러 프로세스가 들어갈 수 있는 상한선을 정해놓고 그 상한선이 찼을 때 lock을 거는 방식으로 한다.
