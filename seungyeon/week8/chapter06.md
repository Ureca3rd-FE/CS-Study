# 저장 프로시저(stored procedure)

> 일련의 쿼리를 하나의 함수처럼 실행하기 위한 쿼리문의 집합<br>
> = 특정 로직의 쿼리를 함수로 만들어 놓은 것<br>
> = 여러 쿼리문을 한 번의 요청으로 꿍쳐둔 것

(sass로 한 css의 그룹화와 비슷할지도...)

함수와의 차이

- 저장 프로시저:
  - 리턴값이 없거나 많을 수 있음.
  - 내부에서 commit, rollback 가능.
  - 데이터 처리 작업(insert, update, delete)에 자주 사용.
  - 주로 복잡한 비지니스 로직 수행용.
- 함수:
  - 반드시 하나의 값 리턴.
  - 내부에서 트랜잭션 제어 불가.
  - 계산, 변환 로직, 집계 등 값을 반환하는 연산에 사용.
  - 주로 데이터 계산/조회용

![alt text](source/image5.png)

프로시저를 만들어두면 애플리케이션에서 여러 상황에 따라 해당 쿼리문이 필요할 때 인자 값만 전달하여 쉽게 원하는 결과물을 받아낼 수 있음.

## 일반 쿼리문과 저장 프로시저

### 일반 쿼리문 작동 방식

# 이미지 필요

-- 파싱

1. 구문 분석: 구문에 오류 없나 분석.
2. 개체 이름 확인: 적힌 테이블이 현재 DB에 있는지 확인, 있으면 테이블 내부에 필요한 열이 있는지 확인
3. 사용 권한 확인: 현재 사용자가 해당 테이블에할 권한이 있는지 확인.

--

4. 최적화: 해당 쿼리문이 가장 좋은 성능을 낼 수 있는 경로 결정. (인덱스 사용 여부가 영향)
5. 컴파일 및 실행 계획 등록: 실행계획 결과를 메모리(캐시)에 등록
6. 실행

### 저장 프로시저 작동 방식

#### 정의 단계

# 이미지 필요

1. 구문 분석: 구문에 오류 없나 분석.
2. 지연된 이름 확인: 프로시저를 정하는 시점에서 테이블이 존재하지 않아도 ok.
   - 실행할 땐 존재 여부 확인.
   - 테이블이 존재한다면 확인을 하므로 열, 이름 작성시 주의.
3. 생성 권한 확인: 현재 사용자가 저장 프로시저를 생성할 권한이 있는지 확인.
4. 시스템 테이블 등록: 저장 프로시저의 이름 및 코드가 시스템 테이블에 등록.

#### 첫 실행

# 이미지 필요

구문 분석 단계를 제외하곤 일반적 쿼리문과 동일.<br>
`정의-지연된 이름 확인` 부분에서 미뤄둔 개체 존재 유무를 개체 이름 확인에서 체크.

#### 이후 실행

# 이미지 필요

1. 메모리(캐시) 확인-실행 계획을 가져옴
2. 실행

## 장단점

### 장점

#### 1. 최적화&캐시

최초 실행 시 최적화 상태로 컴파일 되며, 이후 프로시저 캐시에 저장.

만약 해당 프로세스가 여러번 사용되면 다시 컴파일 작업을 거치지 않고 캐시에서 가져오게 됨.

#### 2. 유지보수

작업이 변경될 때 다른 작업은 건드리지 않고 프로시저 내부에서 수정만 하면 됨. (단점이기도 함)

#### 3. 트래픽 감소=네트워크 부하 줄임

(MyBatis 때를 생각해보면...) 클라이언트가 직접 SQL문을 작성하지 않고 프로시저명에 매개변수만 담아 전달하면 됨. (SQL문은 DB가 가지고 있으니)

#### 4. 보안

프로시저 내에서 참조 중인 테이블의 접근을 막을 수 있음.

### 단점

#### 1. 호환성

DB의 프로시저 내부에서만 수정하면 됨<br>
=유지보수성은 좋음<br>
=하지만 때문에

1. Git에 잡히지 않아 버전 관리가 어려움
2. DB 종속성이 증가함 > 다른 DB로 이식 어려움

#### 2. 성능

계산/비지니스 로직 처리 부분에서 프로그래밍 언어인 C나 JAVA보다 성능이 느릴 수 있음.

또한, (SQL 특성상) 수평 확장이 어려운데 로직까지 처리하면 부하가 커짐. > 병목 현상 발생

#### 3. 디버깅

일부 로직은 서버/일부 로직은 DB에 있기도 하고, DB에 있을 경우 단위 테스트 도구로 테스트 및 디버깅 어려움

## 생성 및 호출

```sql
create or replace procedure 프로시저명(
  변수명1 in 데이터타입,
  변수명2 out 데이터타입
) --필수 x
is[
  변수명1 데이터타입;
  변수명2 데이터타입;
  ...
]
begin
  필요한 기능; --인자값 활용 가능
end;

exec 프로시저명; --호출
```

### 예시(in)

```sql
create or replace procedure test(name in varchar2)
is
  msg varchar2(5):="내 이름은";
begin dbms_output.put_line(msg||' '||name);
end;

exec test('승연');
```

```
내 이름은 승연
```

### 예시2

```sql
create or replace procedure test(name out varchar2)
is
begin
  name:='승연'
end;

declare
out_name varchar2(100)

begin
test(out_name);
dbms_output.put_lin('내 이름은'||out_name);
end;
```

```
내 이름은 승연
```

## 참고 자료

- [[DB/데이터베이스] 저장 프로시저(Stored Procedure)](https://eunsun-zizone-zzang.tistory.com/52)
